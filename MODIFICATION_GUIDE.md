# ä¿®æ”¹èªªæ˜Žï¼šå…è¨±å§“åç‚º NULL çš„å€‹äººè³‡æ–™å»ºç«‹

## ðŸ“‹ ä¿®æ”¹æ‘˜è¦

ä¿®æ”¹æ‰€æœ‰ save PHP æª”æ¡ˆï¼Œè®“ç³»çµ±åœ¨ç¬¬ä¸€æ¬¡é‡åˆ°æ–°ç—…æ‚£æ™‚ï¼Œå¯ä»¥è‡ªå‹•å»ºç«‹ personal_info è¨˜éŒ„ï¼Œå³ä½¿æ²’æœ‰å§“åè³‡æ–™ä¹Ÿèƒ½æ­£å¸¸é‹ä½œã€‚

## ðŸ”§ è³‡æ–™åº«ä¿®æ”¹

### 1. ä¿®æ”¹ personal_info è¡¨æ ¼çµæ§‹

```sql
-- å…è¨± name æ¬„ä½ç‚º NULL
ALTER TABLE personal_info 
MODIFY COLUMN name VARCHAR(100) NULL COMMENT 'å§“å';
```

**åŸ·è¡Œæª”æ¡ˆ**: `alter_personal_info.sql`

## ðŸ“ å„æª”æ¡ˆä¿®æ”¹å…§å®¹

### 1. save_blood_pressure.phpï¼ˆè¡€å£“è³‡æ–™ä¸Šå‚³ï¼‰

**ä¿®æ”¹é‡é»ž**ï¼š
- âœ… è‹¥ç—…æ‚£ä¸å­˜åœ¨ï¼Œè‡ªå‹•å»ºç«‹ personal_info è¨˜éŒ„
- âœ… å§“åè¨­ç‚º NULLï¼Œæ€§åˆ¥æš«è¨­ç‚ºã€Œç”·ã€
- âœ… åªéœ€è¦èº«åˆ†è­‰å’Œç”Ÿæ—¥å³å¯å»ºç«‹è¨˜éŒ„

**ä¿®æ”¹å‰**ï¼š
```php
if ($person) {
    $person_id = $person['person_id'];
    // æ›´æ–°ç”Ÿæ—¥
} else {
    sendErrorResponse('æ‰¾ä¸åˆ°å°æ‡‰çš„å€‹äººè³‡æ–™ï¼Œè«‹å…ˆå¡«å¯«å¥åº·èª¿æŸ¥è¡¨å–®');
}
```

**ä¿®æ”¹å¾Œ**ï¼š
```php
if ($person) {
    $person_id = $person['person_id'];
    // æ›´æ–°ç”Ÿæ—¥
} else {
    // è‡ªå‹•å»ºç«‹å€‹äººè³‡æ–™ï¼ˆå§“åç‚º NULLï¼‰
    $stmt = $pdo->prepare("
        INSERT INTO personal_info (id_number, birth_date, gender, name)
        VALUES (?, ?, 'ç”·', NULL)
    ");
    $stmt->execute([$data['idNumber'], $data['birthDate']]);
    $person_id = $pdo->lastInsertId();
}
```

### 2. save_lab_test.phpï¼ˆæª¢é©—æª¢æŸ¥è¡¨å–®ï¼‰

**ä¿®æ”¹é‡é»ž**ï¼š
- âœ… è‹¥ç—…æ‚£ä¸å­˜åœ¨ï¼Œè‡ªå‹•å»ºç«‹ personal_info è¨˜éŒ„
- âœ… å§“åè¨­ç‚º NULLï¼Œæ€§åˆ¥æš«è¨­ç‚ºã€Œç”·ã€
- âœ… ç§»é™¤ã€Œè«‹å…ˆå¡«å¯«å¥åº·èª¿æŸ¥è¡¨å–®ã€çš„éŒ¯èª¤è¨Šæ¯

**ä¿®æ”¹å‰**ï¼š
```php
if ($person) {
    $person_id = $person['person_id'];
} else {
    sendErrorResponse('æ‰¾ä¸åˆ°å°æ‡‰çš„å€‹äººè³‡æ–™ï¼Œè«‹å…ˆå¡«å¯«å¥åº·èª¿æŸ¥è¡¨å–®');
}
```

**ä¿®æ”¹å¾Œ**ï¼š
```php
if ($person) {
    $person_id = $person['person_id'];
    // æ›´æ–°ç”Ÿæ—¥
} else {
    // è‡ªå‹•å»ºç«‹å€‹äººè³‡æ–™ï¼ˆå§“åç‚º NULLï¼‰
    $stmt = $pdo->prepare("
        INSERT INTO personal_info (id_number, birth_date, gender, name)
        VALUES (?, ?, 'ç”·', NULL)
    ");
    $stmt->execute([$data['idNumber'], $data['birthDate']]);
    $person_id = $pdo->lastInsertId();
}
```

### 3. save_metabolic_prevention.phpï¼ˆä»£è¬é˜²æ²»è¡¨å–®ï¼‰

**ä¿®æ”¹é‡é»ž**ï¼š
- âœ… æ”¯æ´å§“åç‚ºç©ºæ™‚ä»èƒ½å»ºç«‹è¨˜éŒ„
- âœ… æ›´æ–°æ™‚è‹¥æœ‰å§“åå‰‡æ›´æ–°ï¼Œæ²’æœ‰å‰‡ä¿æŒåŽŸå€¼
- âœ… æ–°å¢žæ™‚å§“åå¯ä»¥æ˜¯ NULL

**ä¿®æ”¹å¾Œçš„é‚è¼¯**ï¼š
```php
if ($person) {
    // æ›´æ–°ï¼šæœ‰å§“åå°±æ›´æ–°ï¼Œæ²’æœ‰å°±ä¸æ”¹
    if (!empty($data['name'])) {
        // æ›´æ–°åŒ…å«å§“å
    } else {
        // æ›´æ–°ä¸åŒ…å«å§“å
    }
} else {
    // æ–°å¢žï¼šå§“åå¯ä»¥æ˜¯ NULL
    $stmt = $pdo->prepare("
        INSERT INTO personal_info (id_number, name, birth_date, gender)
        VALUES (?, ?, ?, ?)
    ");
    $stmt->execute([
        $data['idNumber'],
        !empty($data['name']) ? $data['name'] : null,
        $data['birthDate'],
        $gender
    ]);
}
```

### 4. save_health_survey.phpï¼ˆå¥åº·èª¿æŸ¥è¡¨å–®ï¼‰

**ä¿®æ”¹é‡é»ž**ï¼š
- âœ… å¥åº·èª¿æŸ¥è¡¨å–®å¿…é ˆå¡«å¯«å§“åï¼ˆå› ç‚ºè¡¨å–®æ¬„ä½æ˜¯å¿…å¡«ï¼‰
- âœ… è‹¥ç—…æ‚£å­˜åœ¨ï¼Œä¸€å®šæœƒæ›´æ–°å§“å
- âœ… è‹¥ç—…æ‚£ä¸å­˜åœ¨ï¼Œå»ºç«‹æ–°è¨˜éŒ„æ™‚åŒ…å«å§“å

**é‚è¼¯èªªæ˜Ž**ï¼š
- å¥åº·èª¿æŸ¥è¡¨å–®çš„å§“åæ˜¯å¿…å¡«æ¬„ä½
- å› æ­¤é€™å€‹è¡¨å–®ç¸½æ˜¯æœƒæ›´æ–°æˆ–å»ºç«‹å®Œæ•´çš„å€‹äººè³‡æ–™
- å…¶ä»–è¡¨å–®å¯ä»¥åœ¨æ²’æœ‰å§“åçš„æƒ…æ³ä¸‹å…ˆå»ºç«‹åŸºæœ¬è³‡æ–™

## ðŸ”„ è³‡æ–™æµç¨‹

### æƒ…å¢ƒ 1ï¼šç—…æ‚£é¦–æ¬¡ä½¿ç”¨è¡€å£“ä¸Šå‚³

```
1. ç”¨æˆ¶å¡«å¯«è¡€å£“è¡¨å–®ï¼ˆåªæœ‰èº«åˆ†è­‰ã€ç”Ÿæ—¥ã€è¡€å£“æ•¸æ“šï¼‰
2. ç³»çµ±æª¢æŸ¥ personal_info è¡¨
3. æ‰¾ä¸åˆ°ç—…æ‚£ â†’ è‡ªå‹•å»ºç«‹
   - id_number: A123456789
   - birth_date: 1958-05-15
   - gender: ç”·
   - name: NULL
4. å„²å­˜è¡€å£“è³‡æ–™æˆåŠŸ
```

### æƒ…å¢ƒ 2ï¼šç—…æ‚£ä¹‹å¾Œå¡«å¯«å¥åº·èª¿æŸ¥

```
1. ç”¨æˆ¶å¡«å¯«å¥åº·èª¿æŸ¥è¡¨å–®ï¼ˆåŒ…å«å§“åï¼šçŽ‹å°æ˜Žï¼‰
2. ç³»çµ±æª¢æŸ¥ personal_info è¡¨
3. æ‰¾åˆ°ç—…æ‚£ï¼ˆä¹‹å‰è¡€å£“ä¸Šå‚³å»ºç«‹çš„ï¼‰â†’ æ›´æ–°è³‡æ–™
   - id_number: A123456789ï¼ˆä¸è®Šï¼‰
   - birth_date: 1958-05-15ï¼ˆå¯èƒ½æ›´æ–°ï¼‰
   - gender: ç”·ï¼ˆå¯èƒ½æ›´æ–°ï¼‰
   - name: çŽ‹å°æ˜Žï¼ˆå¾ž NULL æ›´æ–°ç‚ºå¯¦éš›å§“åï¼‰
4. å„²å­˜å¥åº·èª¿æŸ¥è³‡æ–™æˆåŠŸ
```

### æƒ…å¢ƒ 3ï¼šç—…æ‚£é¦–æ¬¡ä½¿ç”¨å¥åº·èª¿æŸ¥

```
1. ç”¨æˆ¶å¡«å¯«å¥åº·èª¿æŸ¥è¡¨å–®ï¼ˆåŒ…å«å®Œæ•´è³‡æ–™ï¼‰
2. ç³»çµ±æª¢æŸ¥ personal_info è¡¨
3. æ‰¾ä¸åˆ°ç—…æ‚£ â†’ å»ºç«‹æ–°è¨˜éŒ„ï¼ˆåŒ…å«å§“åï¼‰
4. å„²å­˜å¥åº·èª¿æŸ¥è³‡æ–™æˆåŠŸ
```

## âœ… å„ªé»ž

1. **éˆæ´»æ€§æå‡**ï¼šä¸éœ€è¦å¼·åˆ¶é †åºå¡«å¯«è¡¨å–®
2. **ä½¿ç”¨è€…é«”é©—æ”¹å–„**ï¼šä»»ä½•è¡¨å–®éƒ½å¯ä»¥æ˜¯ç¬¬ä¸€å€‹å¡«å¯«çš„è¡¨å–®
3. **è³‡æ–™å®Œæ•´æ€§**ï¼šå¾ŒçºŒè¡¨å–®æœƒè£œå……ç¼ºå°‘çš„è³‡æ–™
4. **å‘ä¸‹ç›¸å®¹**ï¼šç¾æœ‰çš„å®Œæ•´æµç¨‹ä¸å—å½±éŸ¿

## âš ï¸ æ³¨æ„äº‹é …

### 1. å§“åç‚º NULL çš„è™•ç†

åœ¨æŸ¥è©¢æˆ–é¡¯ç¤ºè³‡æ–™æ™‚ï¼Œéœ€è¦è™•ç†å§“åå¯èƒ½ç‚º NULL çš„æƒ…æ³ï¼š

```php
// PHP ä¸­çš„è™•ç†
$displayName = $person['name'] ?? 'æœªæä¾›å§“å';

// SQL æŸ¥è©¢ä¸­çš„è™•ç†
SELECT 
    COALESCE(name, 'æœªæä¾›å§“å') as display_name,
    id_number,
    birth_date
FROM personal_info;
```

### 2. æ€§åˆ¥é è¨­å€¼

ç•¶é€éŽè¡€å£“ä¸Šå‚³æˆ–æª¢é©—æª¢æŸ¥å»ºç«‹ç—…æ‚£æ™‚ï¼Œæ€§åˆ¥æœƒæš«æ™‚è¨­ç‚ºã€Œç”·ã€ï¼š

```php
// é€™äº›è¡¨å–®æ²’æœ‰æ€§åˆ¥æ¬„ä½ï¼Œæ‰€ä»¥é è¨­ç‚ºç”·
// å¾ŒçºŒå¡«å¯«å¥åº·èª¿æŸ¥æˆ–ä»£è¬é˜²æ²»è¡¨å–®æ™‚æœƒæ›´æ–°ç‚ºæ­£ç¢ºçš„æ€§åˆ¥
gender: 'ç”·'  // é è¨­å€¼
```

### 3. è³‡æ–™å®Œæ•´æ€§æª¢æŸ¥

å»ºè­°åœ¨ç®¡ç†å¾Œå°æˆ–å ±è¡¨ä¸­åŠ å…¥æª¢æŸ¥ï¼š

```sql
-- æŸ¥è©¢å§“åç‚ºç©ºçš„ç—…æ‚£
SELECT id_number, birth_date, gender
FROM personal_info
WHERE name IS NULL;

-- æŸ¥è©¢åªæœ‰éƒ¨åˆ†è³‡æ–™çš„ç—…æ‚£
SELECT 
    p.id_number,
    p.name,
    CASE WHEN h.survey_id IS NULL THEN 'æœªå¡«å¯«' ELSE 'å·²å¡«å¯«' END as health_survey,
    CASE WHEN COUNT(b.bp_id) > 0 THEN 'æœ‰è³‡æ–™' ELSE 'ç„¡è³‡æ–™' END as blood_pressure
FROM personal_info p
LEFT JOIN health_survey h ON p.person_id = h.person_id
LEFT JOIN blood_pressure b ON p.person_id = b.person_id
GROUP BY p.person_id;
```

## ðŸ“¦ éƒ¨ç½²æ­¥é©Ÿ

### æ­¥é©Ÿ 1ï¼šå‚™ä»½è³‡æ–™åº«

```bash
mysqldump -u root -p data_collection_system > backup_before_name_null.sql
```

### æ­¥é©Ÿ 2ï¼šåŸ·è¡Œè³‡æ–™åº«ä¿®æ”¹

```bash
mysql -u root -p data_collection_system < alter_personal_info.sql
```

### æ­¥é©Ÿ 3ï¼šæ›´æ–° PHP æª”æ¡ˆ

å°‡ä»¥ä¸‹æª”æ¡ˆä¸Šå‚³åˆ°ä¼ºæœå™¨çš„ `php/` ç›®éŒ„ï¼š
- save_blood_pressure.php
- save_lab_test.php
- save_metabolic_prevention.php
- save_health_survey.php

### æ­¥é©Ÿ 4ï¼šæ¸¬è©¦

1. æ¸¬è©¦è¡€å£“ä¸Šå‚³ï¼ˆæ–°ç—…æ‚£ï¼Œç„¡å§“åï¼‰
2. æ¸¬è©¦æª¢é©—æª¢æŸ¥ï¼ˆæ–°ç—…æ‚£ï¼Œç„¡å§“åï¼‰
3. æ¸¬è©¦ä»£è¬é˜²æ²»ï¼ˆæ–°ç—…æ‚£ï¼Œæœ‰å§“åï¼‰
4. æ¸¬è©¦å¥åº·èª¿æŸ¥ï¼ˆæ›´æ–°ç¾æœ‰ç—…æ‚£ï¼Œè£œå……å§“åï¼‰

## ðŸ§ª æ¸¬è©¦æ¡ˆä¾‹

### æ¸¬è©¦ 1ï¼šè¡€å£“ä¸Šå‚³ï¼ˆæ–°ç—…æ‚£ï¼‰

```bash
curl -X POST http://your-site/php/save_blood_pressure.php \
  -H "Content-Type: application/json" \
  -d '{
    "idNumber": "Z999999999",
    "birthDate": "1970-01-01",
    "cardDate": "2024-12-09",
    "visitNumber": "0001",
    "systolicBP": 120,
    "diastolicBP": 80
  }'
```

**é æœŸçµæžœ**ï¼š
```json
{
  "success": true,
  "message": "è¡€å£“è³‡æ–™ä¸Šå‚³æˆåŠŸ",
  "data": {
    "person_id": 123,
    "bp_id": 456,
    "bp_status": "æ­£å¸¸"
  }
}
```

**è³‡æ–™åº«æª¢æŸ¥**ï¼š
```sql
SELECT * FROM personal_info WHERE id_number = 'Z999999999';
-- æ‡‰è©²çœ‹åˆ°ï¼šname = NULL, gender = 'ç”·'
```

### æ¸¬è©¦ 2ï¼šå¥åº·èª¿æŸ¥ï¼ˆè£œå……å§“åï¼‰

æŽ¥çºŒæ¸¬è©¦ 1ï¼Œä½¿ç”¨åŒä¸€å€‹èº«åˆ†è­‰è™Ÿç¢¼å¡«å¯«å¥åº·èª¿æŸ¥ï¼š

```javascript
// è¡¨å–®è³‡æ–™åŒ…å«å®Œæ•´å§“å
{
  idNumber: "Z999999999",
  name: "æ¸¬è©¦å§“å",
  birthDate: "1970-01-01",
  gender: "ç”·",
  // ... å…¶ä»–å¿…å¡«æ¬„ä½
}
```

**è³‡æ–™åº«æª¢æŸ¥**ï¼š
```sql
SELECT * FROM personal_info WHERE id_number = 'Z999999999';
-- æ‡‰è©²çœ‹åˆ°ï¼šname = 'æ¸¬è©¦å§“å'ï¼ˆå·²å¾ž NULL æ›´æ–°ï¼‰
```

## ðŸ“Š å½±éŸ¿ç¯„åœ

### ä¿®æ”¹çš„æª”æ¡ˆï¼ˆ4å€‹ï¼‰

1. âœ… save_blood_pressure.php
2. âœ… save_lab_test.php
3. âœ… save_metabolic_prevention.php
4. âœ… save_health_survey.php

### ä¸éœ€ä¿®æ”¹çš„æª”æ¡ˆ

- get_*.phpï¼ˆæŸ¥è©¢æª”æ¡ˆï¼‰ï¼šåªæ˜¯è®€å–ï¼Œä¸å—å½±éŸ¿
- config.phpï¼šé…ç½®æª”æ¡ˆï¼Œä¸éœ€ä¿®æ”¹
- manage_doctors.phpï¼šé†«å¸«ç®¡ç†ï¼Œä¸æ¶‰åŠç—…æ‚£è³‡æ–™

### å‰ç«¯æª”æ¡ˆ

æ‰€æœ‰å‰ç«¯ HTML æª”æ¡ˆéƒ½ä¸éœ€è¦ä¿®æ”¹ï¼Œå› ç‚ºï¼š
- API ä»‹é¢ä¿æŒä¸è®Š
- éŒ¯èª¤è™•ç†é‚è¼¯å·²æ”¹ç‚ºè‡ªå‹•å»ºç«‹
- è¡¨å–®é©—è­‰è¦å‰‡ä¸è®Š

## ðŸ” è³‡æ–™åº«çµæ§‹è®Šæ›´

```sql
-- ä¿®æ”¹å‰
CREATE TABLE personal_info (
    person_id INT AUTO_INCREMENT PRIMARY KEY,
    id_number VARCHAR(10) NOT NULL UNIQUE,
    name VARCHAR(100) NOT NULL,  -- NOT NULL
    birth_date DATE NOT NULL,
    gender ENUM('ç”·', 'å¥³') NOT NULL,
    ...
);

-- ä¿®æ”¹å¾Œ
CREATE TABLE personal_info (
    person_id INT AUTO_INCREMENT PRIMARY KEY,
    id_number VARCHAR(10) NOT NULL UNIQUE,
    name VARCHAR(100) NULL,  -- æ”¹ç‚º NULL
    birth_date DATE NOT NULL,
    gender ENUM('ç”·', 'å¥³') NOT NULL,
    ...
);
```

## ðŸ“ é–‹ç™¼å»ºè­°

### 1. å‰ç«¯é¡¯ç¤ºè™•ç†

```javascript
// Vue.js ç¯„ä¾‹
computed: {
  displayName() {
    return this.person.name || 'æœªæä¾›å§“å';
  }
}
```

### 2. å ±è¡¨ç”¢ç”Ÿ

```php
// ç”¢ç”Ÿå ±è¡¨æ™‚çš„è™•ç†
$name = $row['name'] ?? 'ï¼ˆå§“åæœªç™»è¨˜ï¼‰';
```

### 3. åŒ¯å‡ºåŠŸèƒ½

```php
// CSV åŒ¯å‡º
$csv_data = [
    $row['id_number'],
    $row['name'] ?? '',  // ç©ºå­—ä¸²è€Œéž NULL
    $row['birth_date'],
    // ...
];
```

## âœ¨ ç¸½çµ

é€™æ¬¡ä¿®æ”¹ä½¿ç³»çµ±æ›´åŠ éˆæ´»ï¼Œå…è¨±ç—…æ‚£å¾žä»»ä½•è¡¨å–®é–‹å§‹ä½¿ç”¨ç³»çµ±ï¼Œè€Œä¸éœ€è¦å¼·åˆ¶å…ˆå¡«å¯«å¥åº·èª¿æŸ¥è¡¨å–®ã€‚å¾Œç«¯æœƒè‡ªå‹•è™•ç†å€‹äººè³‡æ–™çš„å»ºç«‹å’Œæ›´æ–°ï¼Œç¢ºä¿è³‡æ–™çš„å®Œæ•´æ€§å’Œä¸€è‡´æ€§ã€‚
